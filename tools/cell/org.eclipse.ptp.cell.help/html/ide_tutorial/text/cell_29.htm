<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html lang="en">
<head>
	<meta http-equiv="Content-Language" content="en-us">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Tutorial</title>
	<link rel="stylesheet" type="text/css" href="../help.css">
</head>
<body>
<h3>Edit the Source Code File</h3>

<p>Copy/Paste the following source code into your editor, then save it (<b>Ctrl+S</b>):</p><pre>#include &#60;stdlib.h&#62;
#include &#60;stdio.h&#62;
#include &#60;errno.h&#62;
#include &#60;libspe2.h&#62;
#include &#60;pthread.h&#62;

extern spe_program_handle_t SPU;

#define SPU_THREADS 	8


void *ppu_pthread_function(void *arg) {
  spe_context_ptr_t ctx;
  unsigned int entry = SPE_DEFAULT_ENTRY;
  
  ctx = *((spe_context_ptr_t *)arg);
  if (spe_context_run(ctx, &#38;entry, 0, NULL, NULL, NULL) &#60; 0) {
    perror ("Failed running context");
    exit (1);
  }
  pthread_exit(NULL);
}


int main()
{
  int i;
  spe_context_ptr_t ctxs[SPU_THREADS];
  pthread_t threads[SPU_THREADS];

  /* Create several SPE-threads to execute 'SPU'.
   */
  for(i=0; i&#60;SPU_THREADS; i++) {
    /* Create context */
    if ((ctxs[i] = spe_context_create (0, NULL)) == NULL) {
      perror ("Failed creating context");
      exit (1);
    }
    /* Load program into context */
    if (spe_program_load (ctxs[i], &#38;SPU)) {
      perror ("Failed loading program");
      exit (1);
    }
    /* Create thread for each SPE context */
    if (pthread_create (&#38;threads[i], NULL, &#38;ppu_pthread_function, &#38;ctxs[i]))  {
      perror ("Failed creating thread");
      exit (1);
    }
  }

  /* Wait for SPU-thread to complete execution.  */
  for (i=0; i&#60;SPU_THREADS; i++) {
    if (pthread_join (threads[i], NULL)) {
      perror("Failed pthread_join");
      exit (1);
    }

    /* Destroy context */
    if (spe_context_destroy (ctxs[i]) != 0) {
      perror("Failed destroying context");
      exit (1);
    }
  }

  printf("\nThe program has successfully executed.\n");

  return (0);
}
 
</pre>

</body>
</html>