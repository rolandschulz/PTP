<?xml version="1.0"?>
<project name="Small PBS Server" default="pack200-jar">
	
	<!--
		Before running tasks in this build file make sure:
		
			1. 	bcel-5.2.jar (http://129.206.117.40:2222/test/bcel-5.2.jar) is added to the ANT classpath. It is needed to create a fileset that only includes dependent classes of a given rootclass, 
				which in our case is org.eclipse.ptp.rm.pbs.jproxy.PBSProxyRuntimeServer.
				  
		 	2. 	test.jar contains both classes org.eclipse.ptp.rm.pbs.jproxy.PBSProxyRuntimeServer does and does not depend on. This pool of classes is used to extract only needed classes and therefore create a PBS server jar that is very small in size. 
		 		Extract test.jar (http://129.206.117.40:2222/test/test.jar) to a folder named test. Move this folder to the location of this build.xml.
		 		
		 	3.  Make sure that ANT can find the pack200 executable by adjusting the appropiate property in the init-task.
		 	
		 	4. Make sure ANT is started with enough heap space using argument -XMX512M  
	 -->


	<target name="init">
		<tstamp />
		<property name="classes.dir" value="test" />
		<property name="pack200.path" value="pack200" />
		<property name="jar-minimal" value="test-minimal.jar" />
		<property name="jar-minimal.pack.gz" value="test-minimal.pack.gz" />
	</target>


	<target name="depend-jar" depends="init">
		<delete file="${jar-minimal}"/>
		
		<antcall target="timestamp"><param name="message" value="Step #1: Creating dependency fileset" /></antcall>
		<classfileset id="reqdClasses" dir="${classes.dir}" rootclass="org.eclipse.ptp.rm.pbs.jproxy.PBSProxyRuntimeServer" />
		
		<!-- 
		<pathconvert pathsep="${line.separator}" property="allclasses" refid="reqdClasses"/>
		<echo>${allclasses}</echo>
		-->
			
		<antcall target="timestamp"><param name="message" value="Step #2: Create jar from dependecy fileset" /></antcall>
		<jar destfile="${jar-minimal}">
			<fileset refid="reqdClasses" />
			<fileset dir="${classes.dir}" includes="*.properties" />
		</jar>
		
	</target>
	
	
	<target name="pack200-jar" depends="depend-jar">
		<delete file="${jar-minimal.pack.gz}"/>

		<antcall target="timestamp"><param name="message" value="Step #3: Compressing Jar (Pack200+GZip)" /></antcall>
		<!-- pack200: Adjust path to pack200 executable -->
		<exec executable="${pack200.path}">
			<arg value="-J-Xmx512M"/>
			<arg value="--segment-limit=-1"/>
			<arg value="${jar-minimal.pack.gz}"/>
			<arg value="${jar-minimal}"/>
		</exec>
	</target>

	
	<target name="timestamp">
	  <tstamp><format property="current.time" pattern="MM/dd/yyyy hh:mm:ss aa" /></tstamp>
	  <echo message="${message} ${current.time}" />      
	</target>

</project>